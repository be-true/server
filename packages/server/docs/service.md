# Сервисы

## Что такое сервис?

Сервис - это любой класс, для которого указана следующая конфигурация:

- name - Имя сервиса на латинице в camelCase. По этому имени будет храниться экземпляр сервиса в DI приложения
- deps [Опционально] - Массив имен сервисов от которого зависит текущий
- config [Опционально] - JSON конфигурация или экземпляр класса библиотеки @be-true/config
- as [Опционально] - Enum `class`, `value`. По умолчанию `class`
- scope [Опционально] - Enum `singleton`, `demand`, `request`. По умолчанию `demand` 
    - `singleton` - Создается экземпляр один раз для всего сервиса
    - `demand` - Создается экземпляр если зависимые сервисы были изменены
    - `request` - Создается экземпляр всегда на каждый запрос
- create [Опционально] - Функция создания сервиса. Значение по умолчанию:
```javascript
create: (di, config) => new service(di, config),
```
- service [Опционально] - Системное поле в которое добавляется класс или значение сервиса

После старта приложения экземпляр этого сервиса помещается в DI приложения и доступен при каждом вызове команды в других сервисах.

## Метод start()

При старте приложения сервисы создаются по очереди исходя из их зависимостей.

Если у класса сервиса есть асинхронный метод start(), то он будет вызван после конструктора и дождется его выполнения. Результат метода start() будет размещен в DI приложения.

Если у класса нет метода start(). То будет вызван только конструктор сервиса и этот экземпляр сервиса будет сам размещен в DI.

## Метод stop()

При остановке приложения в обратной последовательности будет вызван асинхронный метод stop()

## Метод clone()

Создает копию DI, причем данные DI копируются как ссылки

## Метод scope()

Пересоздает экземпляры DI исходя из изменений и указанного параметра `scope`

## Конфигурация 

Конфигурацию можно указать двумя способами:

1) Описав у класса статический метод service(), который возвращает JSON с указанными выше полями
2) При добавлении сервис в приложение передав его вторым параметром эту конфигурацию. При чем если первым способом уже была указанна конфигурация, то она будет переопределена для указанных полей

## Пример создания сервиса

```javascript
class EmailSender {
    static service() {
        return { 
            name: "emailSender",
            deps: ["logger"],
            config: {
                smtpHost: 'https://any.domain',
                smtpPort: 321,
            }
         }
    }

    constructor({ logger }, config) {
        this.logger = logger
        this.config = config;
    }

    async start() {
        // Выполнение какой-то асинхронной операции
        // c использованием this.config
        // необходимой для старта
        return this;
    }

    async stop() {
        // Выполнение какой-то асинхронной операции
        // необходимой для остановки
    }
}
```

##  Добавление сервиса в приложение

```javascript
const { HttpAdapter, HttpTransport } = require("./lib");

const app1 = new Application()
    .addService(EmailSender) // Конфигурация берется полностью из метода service() класса сервиса
    .addService(HttpTransport, { 
        name: 'transportForApp2', // Переопределение имени сервиса, чтобы они не пересекались с transportForApp3.
        config: { host: 'http://app2', port: 80 } 
    })
    .addService(HttpTransport, { 
        name: 'transportForApp3',
        config: { host: 'http://app3', port: 80 } 
    })
    .addService(HttpAdapter, { config: { port: 3001 } }) // Переопределяется конфигурация для подключения Http сервера
```